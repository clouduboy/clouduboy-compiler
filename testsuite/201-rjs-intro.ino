#include <SPI.h>
#include "Arduboy.h"

#include <EEPROM.h>
#include <avr/pgmspace.h>

Arduboy arduboy;

// frame counter, 2-byte unsigned int, max 65536
unsigned int _microcanvas_frame_counter = 0;

// sprintf() textbuffer for drawText
char _microcanvas_textbuffer[32];

// global state machine
unsigned int _microcanvas_state;


PROGMEM const unsigned char gfx_rjs[] = { /*77x15*/ 0xfe, 0x01, 0xfe, 0x02, 0x85, 0x85, 0x05, 0xc5, 0xb9, 0xc2, 0x3c, 0x00, 0x00, 0x00, 0xfe, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x01, 0x7e, 0x40, 0x40, 0x40, 0x40, 0x80, 0xfe, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x01, 0xfe, 0x02, 0x85, 0x85, 0x05, 0xc5, 0xbb, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x1c, 0x26, 0x5a, 0x97, 0xa0, 0xa3, 0xa5, 0x45, 0xcb, 0x8a, 0x0c, 0x3f, 0x40, 0x3f, 0x01, 0x02, 0x05, 0x0b, 0x16, 0x2c, 0x58, 0x30, 0x00, 0x00, 0x00, 0x01, 0x1b, 0x29, 0x28, 0x50, 0x50, 0x50, 0x28, 0x27, 0x18, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x40, 0x3f, 0x01, 0x01, 0x01, 0x01, 0x00, 0x3f, 0x40, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x40, 0x3f, 0x01, 0x02, 0x05, 0x0b, 0x16, 0x2c, 0x58, 0x30, 0x00, 0x00, 0x20, 0x50, 0x50, 0x28, 0x27, 0x10, 0x0f, 0x00, 0x00, 0x00, 0x0c, 0x14, 0x2c, 0x28, 0x50, 0x50, 0x60, 0x1b, 0x34, 0x39, 0x0f };

PROGMEM const unsigned char gfx_rjs_logo[] = { /*39x36*/ 0x00, 0x00, 0x00, 0x00, 0xc0, 0x60, 0xb0, 0x50, 0x28, 0x2c, 0x14, 0x8a, 0x8a, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0xa5, 0x8a, 0x8a, 0x14, 0x2c, 0x28, 0x50, 0xb0, 0x60, 0xc0, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x38, 0xc6, 0x3b, 0x04, 0x03, 0x00, 0x00, 0x00, 0x00, 0xc1, 0x62, 0x32, 0xfa, 0x0a, 0xfa, 0x32, 0x62, 0x42, 0x02, 0x42, 0x62, 0x32, 0xfa, 0x0a, 0xfa, 0x32, 0x62, 0xc1, 0x00, 0x00, 0x00, 0x00, 0x03, 0x04, 0x3b, 0xc6, 0x38, 0xc0, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x83, 0x70, 0x8f, 0x70, 0x0d, 0x05, 0x7d, 0x7d, 0x05, 0x7d, 0x7d, 0x05, 0x0d, 0x70, 0x8f, 0x70, 0x83, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff, 0x00, 0x07, 0x18, 0x27, 0x5c, 0xb0, 0xe0, 0x00, 0xc0, 0x30, 0xce, 0x31, 0x0e, 0x01, 0x00, 0x01, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0x01, 0x00, 0x01, 0x0e, 0x31, 0xce, 0x30, 0xc0, 0x00, 0xe0, 0xb0, 0x5c, 0x27, 0x18, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x09, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x09, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

PROGMEM const unsigned char gfx_dino[] = { /*20x24*/ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xfb, 0xff, 0xff, 0xbf, 0xbf, 0xbf, 0x3f, 0x3e, 0x7e, 0xf8, 0xf0, 0xe0, 0xe0, 0xf0, 0xf8, 0xfc, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x04, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x7f, 0x5f, 0x0f, 0x07, 0x0f, 0x7f, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

PROGMEM const unsigned char gfx_dino_eek[] = { /*20x24*/ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xf5, 0xfb, 0xb5, 0xdf, 0x5f, 0x5f, 0x5f, 0x1f, 0x1e, 0x7e, 0xf8, 0xf0, 0xe0, 0xe0, 0xf0, 0xf8, 0xfc, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x04, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x7f, 0x5f, 0x0f, 0x07, 0x0f, 0x7f, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

PROGMEM const unsigned char gfx_dino_legs[] = { /*20x5x2*/ 0x00, 0x00, 0x00, 0x00, 0x01, 0x0f, 0x0b, 0x01, 0x01, 0x03, 0x1f, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 , 0x00, 0x00, 0x00, 0x00, 0x01, 0x1f, 0x17, 0x03, 0x01, 0x03, 0x0f, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

PROGMEM const unsigned char gfx_dino_kaput[] = { /* 30x18 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0xf8, 0xf0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0xc0, 0x80, 0xc0, 0xf0, 0xa8, 0xd8, 0xa8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf0, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01 };

PROGMEM const unsigned char gfx_clouds[] = { /* 20x16x1 */ 0x1c, 0x22, 0x22, 0x22, 0x24, 0x10, 0x12, 0x2a, 0x21, 0x41, 0x41, 0x41, 0x42, 0x4a, 0x24, 0x24, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, };

PROGMEM const unsigned char gfx_cactus[] = { /* 16x24x2 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xfe, 0x00, 0xc0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xfe, 0x00, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x83, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00 , 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xcf, 0x9e, 0xf0, 0xf8, 0xfc, 0xfc, 0xb8, 0x80, 0xf0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0d, 0x8b, 0xbf, 0xff, 0xff, 0xbf, 0x8f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };


const byte PROGMEM sfx_bling[] = { 0x90, 71, 0,116, 0x80, 0x90, 76, 1,222, 0x80, 0xf0 };

const byte PROGMEM sfx_plop[] = { 0x90, 47, 0, 16, 0x91, 41, 0, 16, 0x80, 0, 35, 0x81, 0xf0 };

const byte PROGMEM sfx_boing[] = { 0x90, 57, 0, 33, 0x80, 0x90, 69, 0, 83, 0x80, 0xf0 };

const byte PROGMEM sfx_eek[] = { 0x90, 87, 0,50, 0x80, 0x90, 82, 0,33, 0x80, 0x90, 87, 0,66, 0x80, 0xf0 };

const byte PROGMEM sfx_bust[] = { 0x90, 47, 0, 50, 0x80, 0x90, 41, 0, 99, 0x80, 0xf0 };

const byte S_INTRO = 1;
const byte S_PLAYING = 2;
const byte S_GAMEOVER = 3;
const byte START_SPEED = 75;
const byte GFX_RJS_WIDTH = 77;
const byte GFX_RJS_HEIGHT = 15;
const byte GFX_RJS_FRAMES = 0;
const byte GFX_RJS_FRAMESIZE = 154;
const byte GFX_RJS_LOGO_WIDTH = 39;
const byte GFX_RJS_LOGO_HEIGHT = 36;
const byte GFX_RJS_LOGO_FRAMES = 0;
const byte GFX_RJS_LOGO_FRAMESIZE = 195;
const byte GFX_DINO_WIDTH = 20;
const byte GFX_DINO_HEIGHT = 24;
const byte GFX_DINO_FRAMES = 0;
const byte GFX_DINO_FRAMESIZE = 60;
const byte GFX_DINO_EEK_WIDTH = 20;
const byte GFX_DINO_EEK_HEIGHT = 24;
const byte GFX_DINO_EEK_FRAMES = 0;
const byte GFX_DINO_EEK_FRAMESIZE = 60;
const byte GFX_DINO_LEGS_WIDTH = 20;
const byte GFX_DINO_LEGS_HEIGHT = 5;
const byte GFX_DINO_LEGS_FRAMES = 2;
const byte GFX_DINO_LEGS_FRAMESIZE = 20;
const byte GFX_DINO_KAPUT_WIDTH = 30;
const byte GFX_DINO_KAPUT_HEIGHT = 18;
const byte GFX_DINO_KAPUT_FRAMES = 0;
const byte GFX_DINO_KAPUT_FRAMESIZE = 90;
const byte GFX_CLOUDS_WIDTH = 20;
const byte GFX_CLOUDS_HEIGHT = 16;
const byte GFX_CLOUDS_FRAMES = 1;
const byte GFX_CLOUDS_FRAMESIZE = 40;
const byte GFX_CACTUS_WIDTH = 16;
const byte GFX_CACTUS_HEIGHT = 24;
const byte GFX_CACTUS_FRAMES = 2;
const byte GFX_CACTUS_FRAMESIZE = 48;

int baseline;
int baseline_dino;
int distance;
int obs_cactus_1;
int obs_cactus_2;
int obs_cactus_1_y;
int obs_cactus_2_y;
int obs_cactus_1_y_type;
int obs_cactus_2_y_type;
int dino_jump_frame;
int dino_jump_height = 0;
int dino_run_speed;

void game_setup() {
////// FUNCTION BODY //////
_microcanvas_state = S_PLAYING;
distance = 0;
dino_run_speed = START_SPEED;
obs_cactus_1 = obs_cactus_2 = -WIDTH;
dino_jump_frame = 0;
dino_jump_height = 0;

}
boolean game_intro() {
////// FUNCTION BODY //////
for (int y = -8; y <= 38; y += 2) {
  arduboy.clear();
  arduboy.drawBitmap( 44, 0, gfx_rjs_logo, GFX_RJS_LOGO_WIDTH, GFX_RJS_LOGO_HEIGHT, WHITE );
  arduboy.drawBitmap( 25, y, gfx_rjs, GFX_RJS_WIDTH, GFX_RJS_HEIGHT, WHITE );
  arduboy.display(); delay(1*16);
}
{
arduboy.setCursor( 42, 55 );
arduboy.print( "presents" );
};
arduboy.tunes.playScore( sfx_bling );
arduboy.setRGBled(96, 0, 128);
arduboy.display(); delay(6*16);
arduboy.setRGBled(0, 0, 0);
arduboy.display(); delay(60*16);
int y = 12;
arduboy.drawBitmap( 54 - 2, y - 1, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, BLACK );
arduboy.drawBitmap( 54 + 1, y + 1, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, BLACK );
for (int frame = 0; frame < 36; ++frame) {
  int rx = random( 0, 2 ) - 1;
  int ry = random( 0, 2 ) - 1;
  int noise = 0;
  if (frame % 3 == 0) {
  arduboy.drawBitmap( rx + 54, ry + y, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, WHITE );
} else {
  arduboy.drawBitmap( rx + 54 + noise, ry + y + noise, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, BLACK );
}
  arduboy.display(); delay(1*16);
}
while (y < baseline_dino) {
  y += 1 + y / 10;
  if (y > baseline_dino) y = baseline_dino;
  arduboy.clear();
  arduboy.drawBitmap( 44, 0, gfx_rjs_logo, GFX_RJS_LOGO_WIDTH, GFX_RJS_LOGO_HEIGHT, WHITE );
  arduboy.drawBitmap( 25, 38, gfx_rjs, GFX_RJS_WIDTH, GFX_RJS_HEIGHT, WHITE );
  {
arduboy.setCursor( 42, 55 );
arduboy.print( "pr   nts" );
};
  {
arduboy.setCursor( 54, 55 + (y > 32 ? y - 32 : 0) );
arduboy.print( "ese" );
};
  arduboy.drawBitmap( 54 - 2, y - 1, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, BLACK );
  arduboy.drawBitmap( 54 + 1, y + 1, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, BLACK );
  arduboy.drawBitmap( 54, y, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, WHITE );
  arduboy.display(); delay(1*16);
}
arduboy.tunes.playScore( sfx_plop );
arduboy.display(); delay(120*16);
for (int i = 0; i < 64; ++i) {
  int z = (i < 54 ? i : 54);
  arduboy.drawBitmap( 54 - z + 1, y, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, BLACK );
  arduboy.fillRect( 0, (i < 32 ? i * 2 : 127 - i * 2), 128, 1, BLACK );
  arduboy.drawBitmap( 54 - z, y, gfx_dino, GFX_DINO_WIDTH, GFX_DINO_HEIGHT, WHITE );
  arduboy.display(); delay(1*16);
}
arduboy.display(); delay(10*16);

}
boolean game_play() {
////// FUNCTION BODY //////


}
boolean game_over() {
////// FUNCTION BODY //////


}


void setup() {
  arduboy.begin();

////// CUSTOM SETUP //////
baseline = HEIGHT - 5;
baseline_dino = HEIGHT - GFX_DINO_HEIGHT;
_microcanvas_state = S_INTRO;
}


void loop() {
  if (!arduboy.nextFrame()) return;

  ++_microcanvas_frame_counter;
  if (_microcanvas_frame_counter==60000) _microcanvas_frame_counter = 0;

////// LOOP CONTENTS TO FOLLOW //////
if (_microcanvas_state == S_INTRO) {
  if (arduboy.pressed( B_BUTTON )) return game_setup();
  int ended = game_intro();
  if (!ended) return;
  return game_setup();
}
arduboy.clear();
if (arduboy.everyXFrames( 5 )) {
  if (arduboy.pressed( LEFT_BUTTON )) {
  {
arduboy.setCursor( 80, 50 );
arduboy.print( "<" );
};
}
  if (arduboy.pressed( RIGHT_BUTTON )) {
  {
arduboy.setCursor( 93, 50 );
arduboy.print( ">" );
};
}
  if (arduboy.pressed( UP_BUTTON )) {
  {
arduboy.setCursor( 84, 45 );
arduboy.print( "/\\" );
};
}
  if (arduboy.pressed( DOWN_BUTTON )) {
  {
arduboy.setCursor( 84, 55 );
arduboy.print( "\\/" );
};
}
  if (arduboy.pressed( A_BUTTON )) {
  {
arduboy.setCursor( 102, 50 );
arduboy.print( "A" );
};
}
  if (arduboy.pressed( B_BUTTON )) {
  {
arduboy.setCursor( 110, 50 );
arduboy.print( "B" );
};
}
}
if (_microcanvas_state == S_PLAYING) {
  int ended = game_play();
  if (!ended) return;
  _microcanvas_state = S_GAMEOVER;
  return;
}
if (_microcanvas_state == S_GAMEOVER) {
  int ended = game_over();
  if (arduboy.pressed( B_BUTTON )) ended = true;
  if (!ended) return;
  return game_setup();
}
////// END OF LOOP CONTENTS //////

  arduboy.display();
}

